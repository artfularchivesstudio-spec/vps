#!/usr/bin/env node

// ğŸ­ The OpenAPI Type Conjurer - Where YAML becomes TypeScript Magic! âœ¨
// ğŸª A theatrical performance of type generation and API sorcery

const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

// ğŸ¨ Our stage directions and magical constants
const CONFIG = {
  openApiDir: path.join(__dirname, '../config/openapi'),
  outputDir: path.join(__dirname, '../generated/openapi-types'),
  mainSpec: 'openapi.yaml'
};

// ğŸ­ The Grand Performance Logger - Because every show needs a narrator
class TheatricalLogger {
  static success(message) {
    console.log(`âœ¨ ${message}`);
  }
  
  static info(message) {
    console.log(`ğŸª ${message}`);
  }
  
  static error(message) {
    console.error(`ğŸ’¥ ${message}`);
  }
  
  static warning(message) {
    console.warn(`âš ï¸  ${message}`);
  }
}

// ğŸª The Type Generation Maestro - Orchestrates the entire performance
class OpenAPITypeGenerator {
  constructor() {
    this.logger = TheatricalLogger;
  }
  
  // ğŸ¬ The opening act - Prepare the stage for our performance
  async prepareStage() {
    this.logger.info('Preparing the grand stage for type generation...');
    
    // ğŸ—ï¸ Ensure our output directory exists (like setting up the theater)
    if (!fs.existsSync(CONFIG.outputDir)) {
      fs.mkdirSync(CONFIG.outputDir, { recursive: true });
      this.logger.success('Created the mystical output directory!');
    }
    
    // ğŸ” Check if our OpenAPI spec exists (the sacred script)
    const specPath = path.join(CONFIG.openApiDir, CONFIG.mainSpec);
    if (!fs.existsSync(specPath)) {
      this.logger.error(`The sacred OpenAPI scroll is missing at: ${specPath}`);
      this.logger.info('ğŸ’¡ Hint: Create your OpenAPI specification first!');
      process.exit(1);
    }
    
    return specPath;
  }
  
  // ğŸ­ The main performance - Generate types with theatrical flair
  async generateTypes(specPath) {
    this.logger.info('ğŸµ Beginning the type generation symphony...');
    
    try {
      const outputPath = path.join(CONFIG.outputDir, 'api-types.ts');
      
      // ğŸª„ Cast the openapi-typescript spell
      const command = `npx openapi-typescript "${specPath}" --output "${outputPath}"`;
      
      this.logger.info('ğŸ”® Invoking the TypeScript transformation spell...');
      execSync(command, { stdio: 'inherit' });
      
      // ğŸ¨ Add our theatrical header to the generated file
      await this.addTheatricalHeader(outputPath);
      
      this.logger.success('ğŸ‰ Types have been conjured successfully!');
      this.logger.info(`ğŸ“œ Your magical types await at: ${outputPath}`);
      
    } catch (error) {
      this.logger.error(`The type generation spell has failed: ${error.message}`);
      process.exit(1);
    }
  }
  
  // ğŸ¨ Add our signature theatrical flair to the generated file
  async addTheatricalHeader(filePath) {
    const originalContent = fs.readFileSync(filePath, 'utf8');
    
    const theatricalHeader = `// ğŸ­ Auto-Generated API Types - A TypeScript Masterpiece! âœ¨
// ğŸª Generated by our OpenAPI Type Conjurer on ${new Date().toISOString()}
// ğŸš« DO NOT EDIT MANUALLY - This file is conjured by magical scripts!
// ğŸ”„ To regenerate: npm run types:generate

`;
    
    const enhancedContent = theatricalHeader + originalContent;
    fs.writeFileSync(filePath, enhancedContent);
    
    this.logger.success('Added theatrical flair to the generated types!');
  }
  
  // ğŸ¬ The grand finale - Execute the entire performance
  async performMagic() {
    this.logger.info('ğŸ­ Welcome to the OpenAPI Type Generation Theater!');
    this.logger.info('ğŸª Tonight\'s performance: "From YAML to TypeScript"');
    
    try {
      const specPath = await this.prepareStage();
      await this.generateTypes(specPath);
      
      this.logger.success('ğŸ‰ The performance was a resounding success!');
      this.logger.info('ğŸ‘ Thank you for attending our type generation show!');
      
    } catch (error) {
      this.logger.error(`ğŸ’¥ The show must not go on: ${error.message}`);
      process.exit(1);
    }
  }
}

// ğŸª The Grand Finale - Let the show begin!
if (require.main === module) {
  const generator = new OpenAPITypeGenerator();
  generator.performMagic();
}

module.exports = OpenAPITypeGenerator;